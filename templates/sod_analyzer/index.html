{% extends "layout.html" %}
{% block title %}Analisador de Riscos SoD - {{ super() }}{% endblock %}

{% block head_extra %}
    <style>
        .criticidade-alta { border-left-color: #ef4444; }
        .criticidade-media { border-left-color: #f97316; }
        .criticidade-baixa { border-left-color: #22c55e; }
        .badge.alta { background-color: #ef4444; }
        .badge.media { background-color: #f97316; }
        .badge.baixa { background-color: #22c55e; }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary .accordion-arrow { transform: rotate(180deg); }
    </style>
{% endblock %}

{% block content %}
<div id="sod-analyzer-app">
    <!-- BREADCRUMB -->
    <nav aria-label="Breadcrumb" class="mb-6">
        <ol class="flex items-center gap-1.5 text-sm text-gray-600">
            <li><a href="{{ url_for('home') }}" class="hover:underline">Início</a></li>
            <li class="rtl:rotate-180"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg></li>
            <li><span class="font-semibold text-gray-800">Analisador de Riscos SoD</span></li>
        </ol>
    </nav>

    {% if has_result %}
        <!-- SEÇÃO DE RESULTADOS -->
        <div id="resultado-container">
            <div class="info-header mb-6 p-4 bg-gray-50 border rounded-lg space-y-2">
                {% if resultado.nome_arquivo %}
                <div class="flex justify-between items-center"><span class="flex items-center text-sm text-gray-600"><svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0011.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>Arquivo:</span><span class="font-semibold text-gray-800">{{ resultado.nome_arquivo }}</span></div>
                {% endif %}
                {% if resultado.perfil %}
                <div class="flex justify-between items-center"><span class="flex items-center text-sm text-gray-600"><svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>Perfil:</span><span class="font-semibold text-gray-800">{{ resultado.perfil }}</span></div>
                {% endif %}
                {% if resultado.cenario %}
                <div class="flex justify-between items-center"><span class="flex items-center text-sm text-gray-600"><svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>Tipo de Análise:</span><span class="font-semibold text-gray-800">{% if resultado.cenario == 'criacao' %}Criação{% else %}Manutenção{% endif %}</span></div>
                {% endif %}
            </div>

            {% if resultado.status == 'success' %}
                <div class="p-4 mb-6 rounded-lg text-red-800 bg-red-50 font-medium">{{ resultado.message }}</div>
                <div class="space-y-3">
                {% for titulo_grupo, riscos in resultado.data.items() %}
                    <details class="accordion-item bg-white border rounded-lg overflow-hidden" open>
                        <summary class="accordion-header p-4 cursor-pointer font-semibold flex justify-between items-center hover:bg-gray-50">
                            <span>{{ 'Funcionalidade: ' if resultado.cenario == 'manutencao' else '' }}<strong>{{ titulo_grupo }}</strong></span>
                            <div class="flex items-center gap-3">
                                <span class="bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-full">{{ riscos | length }} risco(s)</span>
                                <svg class="accordion-arrow w-5 h-5 transition-transform transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                        </summary>
                        <div class="accordion-body p-4 border-t bg-gray-50/50">
                            {% for risco in riscos %}
                                <div class="risk-card border-l-4 p-5 mb-4 bg-white rounded-r-lg shadow-sm criticidade-{{ risco.Criticidade | lower }}">
                                    <div class="flex justify-between items-start mb-3">
                                        <h3 class="font-bold text-gray-800 text-base">Risco: {{ risco['ID Risco'] }}</h3>
                                        <span class="badge text-white text-xs font-bold px-3 py-1 rounded-full {{ risco.Criticidade | lower | replace(' ', '') }}">{{ risco.Criticidade }}</span>
                                    </div>
                                    <p class="text-sm text-gray-700 border-t border-gray-200 pt-3">{{ risco['Descrição Risco'] }}</p>
                                    <div class="mt-4 pt-3 border-t border-gray-200">
                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3 text-sm">
                                            {% if risco.Funcionalidade %}
                                            <div class="flex items-start">
                                                <svg class="h-5 w-5 mr-2 flex-shrink-0 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                                </svg>
                                                <div>
                                                    <strong class="font-medium text-gray-700 block">Funcionalidade 1</strong>
                                                    <span class="text-gray-600">{{ risco.Funcionalidade }}</span>
                                                </div>
                                            </div>
                                            {% endif %}
                                            {% if risco['Funcionalidade 2'] %}
                                            <div class="flex items-start">
                                                 <svg class="h-5 w-5 mr-2 flex-shrink-0 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                                </svg>
                                                <div>
                                                    <strong class="font-medium text-gray-700 block">Funcionalidade 2</strong>
                                                    <span class="text-gray-600">{{ risco['Funcionalidade 2'] }}</span>
                                                </div>
                                            </div>
                                            {% endif %}
                                            {% if risco.Perfil %}
                                             <div class="flex items-start">
                                                <svg class="h-5 w-5 mr-2 flex-shrink-0 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                                </svg>
                                                <div>
                                                    <strong class="font-medium text-gray-700 block">Perfil Afetado</strong>
                                                    <span class="text-gray-600">{{ risco.Perfil }}</span>
                                                </div>
                                            </div>
                                            {% endif %}
                                            {% if risco.Sistema %}
                                            <div class="flex items-start">
                                                <svg class="h-5 w-5 mr-2 flex-shrink-0 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v6a2 2 0 002 2h14a2 2 0 002-2v-6a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
                                                </svg>
                                                <div>
                                                    <strong class="font-medium text-gray-700 block">Sistema</strong>
                                                    <span class="text-gray-600">{{ risco.Sistema }}</span>
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </details>
                {% endfor %}
                </div>

            {% elif resultado.status == 'no_risks' %}
                <div class="p-4 mb-6 rounded-lg text-green-800 bg-green-50 font-medium">{{ resultado.message }}</div>
            {% else %}
                <div class="p-4 mb-6 rounded-lg text-red-800 bg-red-50 font-medium"><strong>Erro:</strong> {{ resultado.message }}</div>
            {% endif %}

            <div class="mt-8 text-center">
                <a href="{{ url_for('sod_analyzer') }}" class="inline-block bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Analisar outro arquivo</a>
            </div>
        </div>

    {% else %}
        <!-- SEÇÃO DE UPLOAD -->
        <div id="upload-container">
            <h2 class="text-2xl font-semibold mb-6">Analisador de Riscos SoD</h2>
             {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                    <div class="p-4 mb-4 rounded-lg text-{{ 'red' if category == 'danger' else 'blue' }}-800 bg-{{ 'red' if category == 'danger' else 'blue' }}-50 font-medium">
                        {{ message }}
                    </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            <form id="upload-form" method="post" enctype="multipart/form-data" class="bg-white p-8 rounded-lg border border-gray-200 shadow-sm space-y-8">
                <div>
                    <h3 class="font-semibold text-gray-800"><span class="bg-blue-600 text-white rounded-full h-6 w-6 inline-flex items-center justify-center mr-2">1</span>Selecione o Tipo de Análise</h3>
                    <div class="relative flex w-full max-w-xs p-1 bg-gray-100 rounded-lg mt-4">
                        <input type="radio" name="analysis_type" id="manutencao" value="manutencao" class="sr-only peer/manutencao" checked>
                        <label for="manutencao" class="flex-1 py-2 text-sm font-medium text-center text-gray-600 rounded-md cursor-pointer transition-colors peer-checked/manutencao:bg-white peer-checked/manutencao:text-blue-600 peer-checked/manutencao:shadow">Manutenção</label>
                
                        <input type="radio" name="analysis_type" id="criacao" value="criacao" class="sr-only peer/criacao">
                        <label for="criacao" class="flex-1 py-2 text-sm font-medium text-center text-gray-600 rounded-md cursor-pointer transition-colors peer-checked/criacao:bg-white peer-checked/criacao:text-blue-600 peer-checked/criacao:shadow">Criação</label>
                    </div>
                </div>

                <div>
                    <h3 class="font-semibold text-gray-800"><span class="bg-blue-600 text-white rounded-full h-6 w-6 inline-flex items-center justify-center mr-2">2</span>Envie o Arquivo para Análise</h3>
                    <label for="file-input" id="drop-area" class="mt-4 flex flex-col items-center justify-center w-full h-56 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <svg class="w-10 h-10 mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                            <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Clique para enviar</span> ou arraste e solte</p>
                            <p class="text-xs text-gray-500">Arquivo Excel (.xlsx ou .xls)</p>
                            <div id="filename" class="mt-4 font-bold text-green-600"></div>
                        </div>
                        <input type="file" name="file" id="file-input" accept=".xlsx, .xls" class="hidden">
                    </label>
                </div>
            </form>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
    {% if not has_result %}
    <script>
        const uploadForm = document.getElementById('upload-form');
        const fileInput = document.getElementById('file-input');
        const dropArea = document.getElementById('drop-area');
        const filenameDisplay = document.getElementById('filename');

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                filenameDisplay.textContent = `Arquivo: ${fileInput.files[0].name}`;
                uploadForm.submit();
            }
        });

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.add('border-solid', 'bg-blue-50', 'border-blue-400'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.remove('border-solid', 'bg-blue-50', 'border-blue-400'), false);
        });

        dropArea.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                filenameDisplay.textContent = `Arquivo: ${files[0].name}`;
                uploadForm.submit();
            }
        }, false);
    </script>
    {% endif %}
{% endblock %}

