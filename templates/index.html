<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Centinela</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="toast-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="toast toast-{{ category }}">
                        <span class="toast-icon">
                            {% if category == 'success' %}
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-check-circle-fill" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></svg>
                            {% else %}
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-x-circle-fill" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/></svg>
                            {% endif %}
                        </span>
                        <span class="toast-message">{{ message }}</span>
                        <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <div class="container">
        <div class="app-header">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo Centinela" class="app-logo">
            <div>
                <h1>Centinela</h1>
                <p class="app-slogan">Guardando a integridade dos seus perfis de acesso.</p>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="openTab(event, 'comparar')">
                Comparar
            </button>
            <button class="tab-button" onclick="openTab(event, 'gerenciar')">
                Gerenciar
            </button>
        </div>

        <div id="comparar" class="tab-content active">
          <h2>Análise de Funcionalidades</h2>
          <form id="compareForm">
              <label for="modulo">Módulo de Referência</label>
              <select id="modulo" name="modulo" {% if not is_var_active %}disabled{% endif %}>
                  {% for modulo in modulos %}
                      <option value="{{ modulo }}">{{ modulo }}</option>
                  {% else %}
                      <option disabled selected>Nenhuma base VAR ativa</option>
                  {% endfor %}
              </select>
              <label for="arquivo_analise_label" class="{% if not is_var_active %}disabled{% endif %}">Sua Planilha de Funcionalidades</label>
              <label for="arquivo_analise" class="custom-file-upload {% if not is_var_active %}disabled{% endif %}">
                  <input type="file" id="arquivo_analise" name="arquivo_analise" accept=".xlsx" required {% if not is_var_active %}disabled{% endif %}>
                  <div class="file-upload-icon"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M7.646 5.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 6.707V10.5a.5.5 0 0 1-1 0V6.707L6.354 7.854a.5.5 0 1 1-.708-.708l2-2z"/><path d="M4.406 3.342A5.53 5.53 0 0 1 8 2c2.69 0 4.923 2 5.166 4.579C14.758 6.804 16 8.137 16 9.773 16 11.569 14.502 13 12.687 13H3.781C1.708 13 0 11.366 0 9.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383zm.653.757c-.757.653-1.153 1.44-1.153 2.056v.448l-.445.049C2.064 6.805 1 7.952 1 9.318 1 10.785 2.23 12 3.781 12h8.906C13.98 12 15 10.988 15 9.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 4.825 10.328 3 8 3a4.53 4.53 0 0 0-2.941 1.1z"/></svg></div>
                  <span class="file-upload-text">Clique para selecionar um arquivo</span>
                  <div class="file-info"><span class="file-success-icon">✓</span><span class="file-name-display"></span></div>
              </label>
              <input type="button" value="Executar Comparação" onclick="executarComparacao()" {% if not is_var_active %}disabled{% endif %}>
              {% if not is_var_active %}
                  <p class="helper-text">É necessário ativar uma Planilha VAR na aba "Gerenciar" para poder fazer uma análise.</p>
              {% endif %}
          </form>
          <div id="loading">⏳ Analisando...</div>
          <div id="alerta-modulo" class="alerta"></div>
          <div id="results-area"></div>
          <div id="resultado-container"></div>
        </div>
        
        <div id="gerenciar" class="tab-content">
           <h2>Upload da Planilha do VAR (.xlsx)</h2>
            <p>Faça o upload de uma nova versão da planilha base. Ela será validada antes de aparecer no histórico abaixo.</p>
            <form action="{{ url_for('upload_var') }}" method="post" enctype="multipart/form-data">
                 <label for="arquivo_var" class="custom-file-upload">
                    <input type="file" id="arquivo_var" name="file" accept=".xlsx" required>
                    <div class="file-upload-icon"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M7.646 5.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 6.707V10.5a.5.5 0 0 1-1 0V6.707L6.354 7.854a.5.5 0 1 1-.708-.708l2-2z"/><path d="M4.406 3.342A5.53 5.53 0 0 1 8 2c2.69 0 4.923 2 5.166 4.579C14.758 6.804 16 8.137 16 9.773 16 11.569 14.502 13 12.687 13H3.781C1.708 13 0 11.366 0 9.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383zm.653.757c-.757.653-1.153 1.44-1.153 2.056v.448l-.445.049C2.064 6.805 1 7.952 1 9.318 1 10.785 2.23 12 3.781 12h8.906C13.98 12 15 10.988 15 9.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 4.825 10.328 3 8 3a4.53 4.53 0 0 0-2.941 1.1z"/></svg></div>
                    <span class="file-upload-text">Clique para selecionar o arquivo VAR</span>
                    <div class="file-info"><span class="file-success-icon">✓</span><span class="file-name-display"></span></div>
                </label>
                <input type="submit" value="Fazer Upload e Validar">
            </form>
            <hr style="margin: 25px 0;">
            <h3>Histórico de Uploads</h3>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Arquivo</th>
                        <th>Data do Upload</th>
                        <th>Status</th>
                        <th style="text-align: center;">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in historico %}
                    <tr>
                        <td>{{ item.nome_arquivo_original }}</td>
                        <td>{{ item.timestamp_formatado }}</td>
                        <td>
                            <span class="status-badge status-{{ 'valido' if item.status == 'Válido' else item.status.lower() }}">
                                {{ item.status }}
                            </span>
                        </td>
                        <td style="text-align: center;">
                            {% if item.status == 'Válido' or item.status == 'Arquivado' %}
                                <a href="{{ url_for('ativar_var', upload_id=item.id) }}" class="btn-ativar">Ativar</a>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="4" style="text-align: center;">Nenhum upload realizado ainda.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div id="import-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Gerar Planilha de Importação</h3><span class="close-button" onclick="closeModal()">&times;</span></div>
            <form id="import-form" onsubmit="event.preventDefault(); gerarPlanilhaImportacao();">
                <label for="perfil-id">ID do Perfil</label>
                <input type="text" id="perfil-id" required>
                <label for="perfil-nome">Nome do Perfil</label>
                <input type="text" id="perfil-nome" required>
                <br>
                <input type="submit" value="Gerar e Baixar">
            </form>
            <div class="modal-footer"><p>ⓘ Os valores de ID e Nome do Perfil devem ser obtidos no sistema VAR para garantir a correta importação.</p></div>
        </div>
    </div>

    <footer class="page-footer">
        <p>Desenvolvido por <a href="https://www.linkedin.com/in/marcosaquinojr/" target="_blank" rel="noopener noreferrer">Marcos Aquino</a></p>
    </footer>

    <script>
        let currentAnalysisId = null;

        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) tabcontent[i].style.display = "none";
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) tablinks[i].className = tablinks[i].className.replace(" active", "");
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        async function executarComparacao() {
            const loadingDiv = document.getElementById('loading');
            const resultsArea = document.getElementById('results-area');
            const resultadoContainer = document.getElementById('resultado-container');
            const alertaDiv = document.getElementById('alerta-modulo');
            const form = document.getElementById('compareForm');
            const botao = document.querySelector('#comparar input[type="button"]');
            const formData = new FormData(form);

            if (document.getElementById('arquivo_analise').files.length === 0) {
                alertaDiv.innerText = "⚠️ Por favor, selecione um arquivo para analisar.";
                alertaDiv.style.display = 'block';
                return;
            }

            loadingDiv.style.display = 'block';
            resultsArea.innerHTML = '';
            resultadoContainer.innerHTML = '';
            alertaDiv.style.display = 'none';
            alertaDiv.innerHTML = '';
            botao.disabled = true;

            try {
                const response = await fetch('/comparar', { method: 'POST', body: formData });
                const result = await response.json();

                if (result.erro) {
                    alertaDiv.innerHTML = `❌ Erro: ${result.erro}`;
                    alertaDiv.style.display = 'block';
                    return;
                }
                
                if (result.alerta_modulo) {
                    alertaDiv.innerText = result.alerta_modulo;
                    alertaDiv.style.display = 'block';
                }
                
                const encontrados = result.resultados.filter(r => r.Status === 'Encontrado').length;
                const divergentes = result.resultados.length - encontrados;
                
                let cardHTML = '';
                if (result.show_import_button) {
                    cardHTML = `<div class="results-card"><div class="icon-display icon-success">✓</div><h3>Análise Concluída com Sucesso!</h3><p class="hero-number">${encontrados}</p><p class="hero-label">Funcionalidades Encontradas</p><div class="results-actions"><a href="${result.download_url}" target="_blank" class="action-btn btn-secondary">Baixar Relatório</a><button id="btn-abrir-modal-importacao" class="action-btn btn-primary">Gerar Importação</button></div></div>`;
                } else {
                    cardHTML = `<div class="results-card"><div class="icon-display icon-warning">⚠️</div><h3>Análise Concluída com Ressalvas</h3><p class="hero-label" style="margin-top:1.5rem; font-size: 1.2rem;"><strong style="color: #198754;">${encontrados} Encontradas</strong> | <strong style="color: #dc3545;">${divergentes} com Divergência/Sugestão</strong></p><div class="results-actions"><a href="${result.download_url}" target="_blank" class="action-btn btn-primary">Baixar Relatório Detalhado</a></div></div>`;
                }
                resultsArea.innerHTML = cardHTML;

                const btnModalImportacao = document.getElementById('btn-abrir-modal-importacao');
                if (btnModalImportacao) {
                    btnModalImportacao.addEventListener('click', () => { modal.style.display = 'flex'; });
                }
                currentAnalysisId = result.analysis_id;

                if (result.resultados && result.resultados.length > 0 && !result.show_import_button) {
                    const encontrados_data = result.resultados.filter(r => r.Status === 'Encontrado');
                    const sugestoes_data = result.resultados.filter(r => r.Status === 'Divergente com Sugestão');
                    const divergentes_data = result.resultados.filter(r => r.Status === 'Divergente');
                    resultadoContainer.innerHTML = createAccordion(encontrados_data, sugestoes_data, divergentes_data);
                    
                    document.querySelectorAll('.accordion-header').forEach(header => {
                        header.addEventListener('click', () => {
                            header.classList.toggle('active');
                            const content = header.nextElementSibling;
                            if (content.style.maxHeight) {
                                content.style.maxHeight = null;
                            } else {
                                content.style.maxHeight = content.scrollHeight + "px";
                            }
                        });
                    });
                }
            } catch (error) {
                alertaDiv.innerText = "❌ Ocorreu um erro na comunicação com o servidor.";
                alertaDiv.style.display = 'block';
                console.error("Erro:", error);
            } finally {
                loadingDiv.style.display = 'none';
                botao.disabled = false;
            }
        }
        
        function createAccordion(encontrados, sugestoes, divergentes) {
            let html = '';
            if(encontrados.length > 0) html += createAccordionSection('✅ Encontrados', encontrados.length, encontrados, item => `<td>${item['Funcionalidade Analisada']}</td><td><strong>${item['Sugestão Similar (VAR)']}</strong></td>`, ['Func. Analisada', 'Correspondência no VAR']);
            if(sugestoes.length > 0) html += createAccordionSection('⚠️ Com Sugestão', sugestoes.length, sugestoes, item => `<td>${item['Funcionalidade Analisada']}</td><td>${item['Sugestão Similar (VAR)']}</td><td>${item['Similaridade (%)']}%</td>`, ['Func. Analisada', 'Sugestão no VAR', 'Similaridade']);
            if(divergentes.length > 0) html += createAccordionSection('❌ Divergentes', divergentes.length, divergentes, item => `<td>${item['Funcionalidade Analisada']}</td>`, ['Funcionalidade Analisada']);
            return html;
        }

        function createAccordionSection(title, count, items, rowTemplate, headers) {
            return `<div class="accordion-item"><button class="accordion-header"><span>${title} (${count})</span><span class="arrow">▼</span></button><div class="accordion-content"><table class="result-table"><thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>${items.map(item => `<tr>${rowTemplate(item)}</tr>`).join('')}</tbody></table></div></div>`;
        }

        const modal = document.getElementById('import-modal');
        function closeModal() { modal.style.display = 'none'; }
        window.onclick = function(event) { if (event.target == modal) { closeModal(); } }

        async function gerarPlanilhaImportacao() {
            const perfilId = document.getElementById('perfil-id').value;
            const perfilNome = document.getElementById('perfil-nome').value;

            if (!perfilId || !perfilNome) {
                alert('Por favor, preencha os campos ID e Perfil.');
                return;
            }

            try {
                const response = await fetch('/gerar_importacao', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ analysis_id: currentAnalysisId, perfil_id: perfilId, perfil_nome: perfilNome })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    let filename = 'importacao.xlsx';
                    
                    const contentDisposition = response.headers.get('Content-Disposition');
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename="?([^"]+)"?/i);
                        if (filenameMatch && filenameMatch.length > 1) {
                            filename = filenameMatch[1];
                        }
                    }
                    
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                    closeModal();
                } else {
                    const error = await response.json();
                    alert(`Erro ao gerar planilha: ${error.erro}`);
                }
            } catch (err) {
                alert('Erro de comunicação ao gerar a planilha.');
                console.error(err);
            }
        }

        document.querySelectorAll('.custom-file-upload').forEach(uploadComponent => {
            const fileInput = uploadComponent.querySelector('input[type="file"]');
            const fileInfo = uploadComponent.querySelector('.file-info');
            const fileNameDisplay = uploadComponent.querySelector('.file-name-display');
            const originalText = uploadComponent.querySelector('.file-upload-text');
            const icon = uploadComponent.querySelector('.file-upload-icon');

            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 0) {
                    fileNameDisplay.textContent = fileInput.files[0].name;
                    fileInfo.style.display = 'flex';
                    originalText.style.display = 'none';
                    icon.style.display = 'none';
                } else {
                    fileInfo.style.display = 'none';
                    originalText.style.display = 'block';
                    icon.style.display = 'block';
                }
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const tabToActivate = params.get('tab');
            if (tabToActivate) {
                const tabButton = document.querySelector(`.tab-button[onclick*="'${tabToActivate}'"]`);
                if (tabButton) {
                    tabButton.click();
                }
            }

            const toasts = document.querySelectorAll('.toast');
            toasts.forEach((toast, index) => {
                setTimeout(() => {
                    toast.classList.add('fade-out');
                    toast.addEventListener('animationend', () => toast.remove());
                }, 5000 + index * 500);
            });
        });
    </script>
</body>
</html>